# 磁盘性能

## 影响硬盘性能的因素
```md
影响磁盘的关键因素是磁盘服务时间，即磁盘完成一个I/O请求所花费的时间，它由寻道时间、旋转延迟和数据传输时间三部分构成。
```
* 寻道时间
```md
指将读写磁头移动至正确的磁道上所需要的时间。寻道时间越短，I/O操作越快，目前磁盘的平均寻道时间一般在3-15ms。
```
* 旋转延迟
```md
指盘片旋转将请求数据所在扇区移至读写磁头下方所需要的时间。
旋转延迟取决于磁盘转速，通常使用磁盘旋转一周所需时间的1/2表示。
比如，7200 rpm的磁盘平均旋转延迟大约为60*1000/7200/2 = 4.17ms，而转速为15000 rpm的磁盘其平均旋转延迟约为2ms。
```
* 数据传输时间
```md
指完成传输所请求的数据所需要的时间，它取决于数据传输率，其值等于数据大小除以数据传输率。
IDE/ATA能达到133MB/s，SATA II可达到300MB/s的接口数据传输率。
数据传输时间通常远小于寻道时间和旋转延迟。简单计算时可忽略。
```

## 性能的指标
* [IOPS](IOPS.md)

* 吞吐量(Throughput)
```md
单位时间内可以成功传输的数据数量。
顺序读写频繁的应用，如视频点播，关注连续读写性能、数据吞吐量是关键衡量指标。
它主要取决于磁盘阵列的架构，通道的大小以及磁盘的个数。
但他们都有自己的内部带宽，一般情况下，内部带宽都设计足够充足，不会存在瓶颈。

磁盘阵列与服务器之间的数据通道对吞吐量影响很大，比如一个2Gbps的光纤通道，其所能支撑的最大流量仅为250MB/s。
最后，当前面的瓶颈都不再存在时，硬盘越多的情况下吞吐量越大。
```

## 统计指标
* [/proc/diskstats](../tools/proc/diskstats.md)
### 指标
* 磁盘IO使用率
```md
采集方式：累计值，每10秒采集一次取差值； 指标: disk.io (key: system)；
io_ticks: 磁盘处理I/O的总时间(ms)，ioticks/1000/10 * 100 -> ioticks/100(0-100的百分比);
```
* 磁盘队列等待时间
```md
数据源: /proc/diskstats; 采集方式：累计值，每10秒采集一次取差值； 指标: disk.io (key: system)；
time_in_queue: 对io_ticks的加权值。
io_ticks是自然时间，不考虑当前有几个I/O，而time_in_queue是用当前的I/O数量in-flight乘以自然时间。
虽然该字段的名称是time_in_queue，但并不真的只是在队列中的时间，其中还包含了硬盘处理I/O的时间。
iostat在计算avgqu-sz时会用到这个字段; time_in_queue/10 -> 即每秒的磁盘队列等待时间；
```
* 写请求数
* 读请求数
```md
采集方式：累计值，每10秒采集一次取差值； 指标: disk.io (key: system)；
write_ios: 写io数 write_ios/10 -> ops/s;
read_ios: 读io数，read_ios/10 -> ops/s;
```
* 写耗时
* 读耗时
```md
采集方式：累计值，每10秒采集一次取差值； 指标: disk.io (key: system)；
write_ticks/write_ios: 平均每次写操作耗时, 总写耗时(ms)/总写io数;
read_ticks/read_ios: 平均每次读操作耗时，总读耗时(ms)/总读io数;
```
* 写扇区次数
* 读扇区次数
```md
采集方式：累计值，每10秒采集一次取差值； 指标: disk.io (key: system)；
write_sectors/10: 每秒写扇区数;
read_sectors/10: 每秒读扇区数;
```
* 写合并数
* 读合并数
```md
采集方式：累计值，每10秒采集一次取差值； 指标: disk.io (key: system)；
write_merges/10: 每秒写合并数;
read_merges/10: 每秒读合并数;
```

## [优化](HP.md)

## Tools
* dd - 测试磁盘性能
```bash
$ time dd if=/dev/zero of=test bs=1M count=1000 
```
* iostat
```sh
iostat -d -k 1 10         #查看TPS和吞吐量信息(磁盘读写速度单位为KB)
iostat -d -m 2            #查看TPS和吞吐量信息(磁盘读写速度单位为MB)
iostat -d -x -k 1 10      #查看设备使用率（%util）、响应时间（await） iostat -c 1 10 #查看cpu状态
```


